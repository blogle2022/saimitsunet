<?
include("his_horo.php");
include("my_horo.php");
include("weekly.php");

$virtualAspect = virtualHoro($horo, $horo2);


$tomorrow = time() + 86400;
$year_tmr = date("Y", $tomorrow);
$month_tmr = date("n", $tomorrow);
$day_tmr = date("j", $tomorrow);

$weeklater = $tomorrow + 86400 * 6;
$year_wek = date("Y", $weeklater);
$month_wek = date("n", $weeklater);
$day_wek = date("j", $weeklater);

$horo_tmr = new HoroScope($year_tmr, $month_tmr, $day_tmr, 0, 0, $lon, $lat, $tz);
$horo_tmr->invokeSWE();
$horo_tmr->getAbsDegree();
$horo_tmr->getAbsDegreeBySign();

$horo_wek = new HoroScope($year_wek, $month_wek, $day_wek, 0, 0, $lon, $lat, $tz);
$horo_wek->invokeSWE();
$horo_wek->getAbsDegree();
$horo_wek->getAbsDegreeBySign();

$moon_tmr = $horo_tmr->planets["Moon"]->absPosBySign;
$moon_wek = $horo_wek->planets["Moon"]->absPosBySign;

if($moon_tmr < 0) $moon_tmr += 360;
if($moon_wek < 0) $moon_wek += 360;

$asps = array(0, 120, 60, 144, 72, 30, 45, 135, 150, 90, 180);
$vplnts = array("Venus", "Mars", "Jupiter", "Mercury", "Moon");
$txtidx = array(
	"Venus" => 1,
	"Mars" => 17,
	"Jupiter" => 33,
	"Mercury" => 49,
	"Moon" => 65);


$mod = $day2 % 2;
foreach ($vplnts as $vpl) {
	$deg = $virtualAspect["$vpl"];
	$idx = $txtidx["$vpl"];
	$msgidx["$vpl"] = 0;
	foreach ($asps as $asp) {
		$lower = $deg - $asp;
		$upper = $deg + $asp;
		if(ri($moon_tmr, $moon_wek, $lower) || ri($moon_tmr, $moon_wek, $upper)) {
			$msgidx["$vpl"] = $idx;
			break;  ## �ߤĤ��ä���ȴ���ʤ��ȡ�������̤��Фޤ���
		}
		$idx++;
	}
	if($msgidx["$vpl"] == 0) {
		$msgidx["$vpl"] = $txtidx["$vpl"] + 11 + $day % 5;
	}

	if(($year_tmr - $year) >= 18) { ## Adult

		$filename[0] = "/srv/phplib/msg/1f_02/a0" . $mod . ".txt";
		$filename[1] = "/srv/phplib/msg/1f_02/a1" . $mod . ".txt";
		$title = array(
			"Venus" => "�����",
			"Mars" => "���å�����",
			"Jupiter" => "�ϥåԡ���",
			"Mercury" => "������",
			"Moon" => "������");

	} else {
		$filename[0] = "/srv/phplib/msg/1f_02/y0" . $mod . ".txt";
		$filename[1] = "/srv/phplib/msg/1f_02/y1" . $mod . ".txt";
		$title = array(
			"Venus" => "�����",
			"Mars" => "���å���",
			"Jupiter" => "�ϥåԡ���",
			"Mercury" => "������",
			"Moon" => "������");

	}
	$offset = 50 * 13 * ($msgidx["$vpl"] - 1);

	$fp[0] = fopen($filename[0], "r");
	fseek($fp[0], $offset);
	for($l=0; $l<13; $l++) {
		$msg["$vpl"][$l] = stripLine(fgets($fp[0]));
	}
	fclose($fp[0]);

	$fp[1] = fopen($filename[1], "r");
	fseek($fp[1], $offset);
	for($l=0; $l<13; $l++) {
		$msg["$vpl"][$l+13] = stripLine(fgets($fp[1]));
	}
	fclose($fp[1]);


}


?>
<input type="hidden" name="command" value="today_1">
							<td align="center" valign="top" bgcolor="#ffcccc"><img src="../images/rtop1.gif" alt="" width="535" height="22" border="0"><br>
<font size="+2" color="#ff9999">������</font><font size="+2"></font><font size="+2" color="gray">Weekly�����ʰ����ԡ�</font><font size="+2" color="#ff9999">������<br>
<hr size="3" width="92%">
<table width="500" border="0" cellspacing="3" cellpadding="8">
<tr>

<td align="center">
<?
include("my_horographic.php");
?>
</td>

</tr>


</td>
</tr>
<tr>
<td align="center">

<table width="100%" border="0" cellspacing="10" cellpadding="0">
<?

foreach($vplnts as $vpl) {
?>
<tr height="25"><td align="center" bgcolor="#ff9999">
<?
echo $title["$vpl"];
?>
</td></tr>
<tr><td>
<?
	for($l=0; $l<count($msg[$vpl]); $l++) {
		if($l%13==0) continue;
		echo $msg[$vpl][$l] . "\n";
	}
?>
</td></tr>
<?
}
?>
</table>
</td>
</tr>



</table>
</font><font size="+3" color="gray">
									<hr size="3" width="92%">
								</font>
<p><img src="../images/runder1.gif" alt="" width="535" height="22" border="0"></p>
</td>
